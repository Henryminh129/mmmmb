<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spartan.Edu | The Ultimate Ecosystem</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
        /* ==========================================================================
           1. CORE DESIGN SYSTEM
           ========================================================================== */
        :root {
            --brand-gradient: linear-gradient(135deg, #FF512F 0%, #DD2476 100%);
            --accent-color: #FF512F;

            /* Light Theme (Default) */
            --bg-main: #F8FAFC;
            --bg-surface: #FFFFFF;
            --bg-sidebar: #FFFFFF;
            --border-color: #E2E8F0;
            --text-primary: #0F172A;
            --text-secondary: #64748B;
            --hover-bg: #F1F5F9;
            --active-bg: #FFF1F2;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);

            /* Status */
            --status-success: #10B981;
            --status-danger: #EF4444;
            --status-info: #3B82F6;

            /* Metrics */
            --sidebar-width: 280px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --font-head: 'Space Grotesk', sans-serif;
            --ease-bounce: cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Dark Theme Toggle */
        body.theme-dark {
            --bg-main: #09090B;
            --bg-surface: #18181B;
            --bg-sidebar: #000000;
            --border-color: #27272A;
            --text-primary: #FAFAFA;
            --text-secondary: #A1A1AA;
            --hover-bg: #27272A;
            --active-bg: rgba(255, 81, 47, 0.15);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.5);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            font-size: 14px;
            transition: background-color 0.3s ease, color 0.3s ease;
            background-color: var(--bg-main);
            color: var(--text-primary);
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(150, 150, 150, 0.3);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(150, 150, 150, 0.5);
        }

        .hidden {
            display: none !important;
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .w-full {
            width: 100%;
        }

        .h-full {
            height: 100%;
        }

        .gap-10 {
            gap: 10px;
        }

        .gap-20 {
            gap: 20px;
        }

        .font-head {
            font-family: var(--font-head);
        }

        /* Animation Keyframes */
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        /* --- UI COMPONENTS --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
            user-select: none;
        }

        .btn:active {
            transform: scale(0.96);
        }

        .btn-primary {
            background: var(--brand-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 81, 47, 0.25);
            border: none;
        }

        .btn-primary:hover {
            opacity: 0.95;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-surface);
            border-color: var(--border-color);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--hover-bg);
            border-color: var(--text-secondary);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--status-danger);
            border: 1px solid var(--status-danger);
        }

        .btn-danger:hover {
            background: var(--status-danger);
            color: white;
        }

        .btn-icon-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
            background: rgba(150, 150, 150, 0.1);
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: 0.2s;
            border: none;
        }

        .btn-icon-sm:hover {
            background: var(--accent-color);
            color: white;
        }

        .input-wrapper {
            width: 100%;
            margin-bottom: 15px;
        }

        .input-std {
            width: 100%;
            padding: 12px;
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            transition: 0.2s;
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .input-std:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(255, 81, 47, 0.15);
        }

        .file-input {
            margin-top: 5px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* --- TOAST --- */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 99999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            min-width: 300px;
            padding: 15px 20px;
            border-radius: 8px;
            background: var(--bg-surface);
            color: var(--text-primary);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInToast 0.4s var(--ease-bounce);
            border-left: 4px solid var(--accent-color);
            border: 1px solid var(--border-color);
            border-left-width: 4px;
        }

        .toast.success {
            border-left-color: var(--status-success);
        }

        .toast.error {
            border-left-color: var(--status-danger);
        }

        @keyframes slideInToast {
            from {
                opacity: 0;
                transform: translateX(50px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* --- IMAGE UPLOAD & REMOVE --- */
        .file-upload-box {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s var(--ease-bounce);
            background: rgba(150, 150, 150, 0.03);
            position: relative;
            margin-top: 5px;
        }

        .file-upload-box:hover {
            border-color: var(--accent-color);
            background: rgba(255, 81, 47, 0.05);
            transform: translateY(-2px);
        }

        .file-upload-box.has-file {
            border-style: solid;
            border-color: var(--status-success);
            background: rgba(16, 185, 129, 0.1);
        }

        .file-upload-box i {
            font-size: 1.5rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: block;
            transition: 0.3s;
        }

        .file-upload-box:hover i {
            transform: scale(1.1);
            color: var(--accent-color);
        }

        .hidden-input {
            display: none;
        }

        .image-preview-wrapper {
            position: relative;
            margin-top: 10px;
            display: none;
        }

        .card-img-preview {
            width: 100%;
            height: 150px;
            border-radius: 8px;
            object-fit: cover;
            animation: fadeIn 0.5s;
            border: 1px solid var(--border-color);
        }

        .btn-remove-image {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: var(--status-danger);
            color: white;
            border: 2px solid var(--bg-surface);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: 0.2s;
        }

        .btn-remove-image:hover {
            transform: scale(1.1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal-box {
            width: 450px;
            max-width: 90%;
            padding: 30px;
            border-radius: var(--radius-lg);
            transform: translateY(20px);
            transition: transform 0.3s var(--ease-bounce);
            max-height: 90vh;
            overflow-y: auto;
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            box-shadow: var(--shadow-lg);
        }

        .modal-overlay.active .modal-box {
            transform: translateY(0);
        }

        /* Keybind Grid */
        .bind-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .bind-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .bind-key {
            font-weight: bold;
            color: var(--accent-color);
        }

        .bind-input {
            width: 50px;
            text-align: center;
            padding: 5px;
            border: 1px solid var(--border-color);
            background: var(--bg-main);
            color: var(--text-primary);
            border-radius: 4px;
            text-transform: uppercase;
        }

        .card-img-display {
            max-width: 100%;
            max-height: 120px;
            margin-bottom: 15px;
            border-radius: 6px;
            object-fit: contain;
        }

        /* ==========================================================================
           2. APP LAYOUT & AUTH (Landing Style)
           ========================================================================== */
        #auth-screen {
            position: fixed;
            inset: 0;
            z-index: 100;
            background: radial-gradient(circle at 10% 10%, rgba(255, 81, 47, 0.05), transparent 40%), var(--bg-main);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .landing-container {
            width: 1200px;
            max-width: 95%;
            display: grid;
            grid-template-columns: 1fr 450px;
            gap: 80px;
            align-items: center;
        }

        .landing-hero {
            animation: slideInLeft 0.6s ease;
        }

        .logo-landing {
            font-family: var(--font-head);
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 60px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-landing i {
            color: var(--accent-color);
        }

        .hero-title {
            font-family: var(--font-head);
            font-size: 3.5rem;
            font-weight: 800;
            line-height: 1.1;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .hero-title span {
            background: var(--brand-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .hero-sub {
            font-size: 1.1rem;
            color: var(--text-secondary);
            line-height: 1.6;
            max-width: 500px;
            margin-bottom: 40px;
        }

        .auth-card {
            background: var(--bg-surface);
            backdrop-filter: blur(20px);
            padding: 50px 40px;
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            animation: slideInRight 0.6s ease;
        }

        .auth-header {
            margin-bottom: 30px;
        }

        .auth-header h2 {
            font-family: var(--font-head);
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .auth-form {
            animation: slideInRight 0.5s ease;
            width: 100%;
        }

        .input-group {
            position: relative;
            width: 100%;
            margin-bottom: 15px;
        }

        .input-group i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #9CA3AF;
            pointer-events: none;
        }

        .input-group input {
            padding-left: 40px;
        }

        /* App Shell */
        #app-shell {
            display: flex;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .sidebar {
            width: var(--sidebar-width);
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 30px 20px;
            border-right: 1px solid var(--border-color);
            flex-shrink: 0;
            transition: 0.3s;
            background: var(--bg-sidebar);
        }

        .nav-item {
            padding: 12px 16px;
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            transition: 0.2s;
            margin-bottom: 5px;
        }

        .nav-item:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--active-bg);
            color: var(--accent-color);
        }

        .settings-widget {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .settings-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
            color: var(--text-primary);
        }

        .settings-btn:hover {
            background: var(--hover-bg);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .user-widget {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-primary);
        }

        /* ==========================================================================
           MODULES
           ========================================================================== */
        /* Piano */
        #mod-piano {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: var(--bg-main);
        }

        .piano-header {
            width: 90%;
            max-width: 1200px;
            height: 80px;
            margin-top: 30px;
            background: var(--brand-gradient);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
            color: white;
            box-shadow: var(--shadow-lg);
            flex-shrink: 0;
        }

        .piano-stage {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            overflow: hidden;
        }

        .piano-case {
            background: var(--bg-surface);
            padding: 50px;
            border-radius: 30px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .keys-wrapper {
            display: flex;
            position: relative;
            height: 280px;
        }

        .key {
            border: 1px solid #94A3B8;
            border-top: none;
            border-radius: 0 0 5px 5px;
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 10px;
            font-weight: 700;
            font-size: 10px;
            user-select: none;
            transition: transform 0.05s, background 0.1s;
        }

        .key-white {
            width: 50px;
            height: 100%;
            background: white;
            z-index: 1;
            color: #475569;
        }

        .key-white.active {
            background: #F1F5F9;
            border-bottom: 8px solid var(--accent-color);
            transform: translateY(2px);
        }

        .key-black {
            width: 30px;
            height: 60%;
            background: #1E293B;
            position: absolute;
            z-index: 2;
            margin-left: -15px;
            border-bottom: 8px solid #0F172A;
            border-radius: 0 0 3px 3px;
            color: rgba(255, 255, 255, 0.5);
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 10px;
        }

        .key-black::after {
            content: '';
            width: 12px;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            position: absolute;
            bottom: 20px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        .key-black.active {
            background: #334155;
            border-bottom: 2px solid var(--accent-color);
            transform: translateY(2px);
        }

        .key-black.active::after {
            background: var(--accent-color);
            box-shadow: 0 0 10px var(--accent-color);
        }

        .key-label {
            position: absolute;
            bottom: 35px;
            font-size: 9px;
            opacity: 0.5;
            text-transform: uppercase;
            pointer-events: none;
        }

        .key-black .key-label {
            bottom: 40px;
            color: white;
        }

        /* Flashcards */
        #mod-flashcards {
            height: 100%;
            background: var(--bg-main);
            display: flex;
            flex-direction: column;
        }

        .fc-header {
            padding: 30px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .fc-header h2 {
            color: var(--text-primary) !important;
        }

        .folder-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            padding: 30px 40px;
            overflow-y: auto;
        }

        .folder-card {
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 25px;
            height: 180px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: 0.3s;
            box-shadow: var(--shadow-md);
            animation: fadeInUp 0.4s ease;
        }

        .folder-card h3 {
            color: var(--text-primary) !important;
        }

        .folder-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-color);
            box-shadow: var(--shadow-lg);
        }

        #fc-overview-panel {
            position: absolute;
            inset: 0;
            background: var(--bg-main);
            z-index: 10;
            display: flex;
            flex-direction: column;
        }

        .mini-card-scene {
            perspective: 1000px;
            height: 200px;
            cursor: pointer;
            position: relative;
            animation: fadeInUp 0.4s ease;
        }

        .mini-card {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.5s var(--ease-bounce);
            border-radius: 12px;
        }

        .mini-card.flipped {
            transform: rotateY(180deg);
        }

        .mini-face {
            position: absolute;
            inset: 0;
            backface-visibility: hidden;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            text-align: center;
            font-weight: 700;
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .mini-face.back {
            transform: rotateY(180deg);
            background: var(--bg-surface);
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
        }

        .btn-edit-float {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 10;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.1);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-edit-float:hover {
            background: var(--accent-color);
            color: white;
        }

        /* Study Overlay (Always Dark) */
        #study-overlay {
            position: fixed;
            inset: 0;
            background: rgba(9, 9, 11, 0.95);
            backdrop-filter: blur(20px);
            z-index: 100;
            display: flex;
            flex-direction: column;
            color: white;
        }

        .study-header {
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .flashcard-stage {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            perspective: 1200px;
        }

        .card-3d {
            width: 600px;
            height: 400px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s var(--ease-bounce);
            cursor: pointer;
        }

        .card-3d.flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            inset: 0;
            backface-visibility: hidden;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
            border: 1px solid #333;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
            flex-direction: column;
        }

        .face-front {
            background: #1E1E21;
            color: white;
            font-size: 2.5rem;
            font-weight: 700;
            font-family: var(--font-head);
        }

        .face-back {
            background: #000;
            color: var(--accent-color);
            transform: rotateY(180deg);
            border: 2px solid var(--accent-color);
            font-size: 2rem;
        }

        /* Tasks */
        #mod-tasks {
            height: 100%;
            display: flex;
            background: var(--bg-main);
            overflow: hidden;
        }

        .task-sidebar {
            width: 280px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            padding: 25px 15px;
            display: flex;
            flex-direction: column;
        }

        .project-item {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            margin-bottom: 5px;
            transition: all 0.3s ease;
            animation: slideInLeft 0.4s ease;
            border: 1px solid transparent;
        }

        .project-item:hover {
            background: var(--hover-bg);
            transform: translateX(5px);
            border-color: var(--border-color);
        }

        .project-item.active {
            background: var(--active-bg);
            color: var(--accent-color);
            font-weight: 700;
            border-left: 3px solid var(--accent-color);
            border-color: transparent;
        }

        .task-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .task-board-header {
            padding: 30px 40px 0;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 20px;
        }

        .task-board-header h2 {
            color: var(--text-primary) !important;
        }

        .task-cols {
            display: grid;
            grid-template-columns: 40px 1fr 150px 120px 100px;
            padding: 12px 10px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            position: sticky;
            top: 0;
            background: var(--bg-main);
            z-index: 5;
        }

        .task-list-container {
            flex: 1;
            overflow-y: auto;
            padding: 0 40px 40px;
        }

        .task-row {
            display: grid;
            grid-template-columns: 40px 1fr 150px 120px 100px;
            padding: 12px 10px;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
            cursor: pointer;
            color: var(--text-primary);
            transition: all 0.2s ease;
            animation: fadeInUp 0.3s ease;
        }

        .task-row:hover {
            background: var(--bg-surface);
            border-radius: 6px;
            transform: translateX(3px);
            box-shadow: var(--shadow-sm);
        }

        .task-row span {
            color: var(--text-primary) !important;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--text-secondary);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: 0.2s;
        }

        .task-row.completed .checkbox {
            background: var(--status-success);
            border-color: var(--status-success);
        }

        .task-row.completed .task-title {
            text-decoration: line-through;
            color: var(--text-secondary) !important;
        }

        .task-detail-panel {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            width: 450px;
            background: var(--bg-surface);
            border-left: 1px solid var(--border-color);
            transform: translateX(100%);
            transition: transform 0.4s var(--ease-bounce);
            z-index: 50;
            padding: 30px;
            display: flex;
            flex-direction: column;
            box-shadow: -20px 0 60px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .task-detail-panel.open {
            transform: translateX(0);
        }
    </style>
</head>

<body class="theme-light">
    <div id="toast-container"></div>

    <div id="auth-screen">
        <div class="landing-container">
            <div class="landing-hero">
                <div class="logo-landing">
                    <i class="fa-solid fa-shield-halved"></i> Spartan.Edu
                </div>
                <h1 class="hero-title">
                    Learn Piano & Vocabulary<br>
                    <span>Double The Effectiveness</span>
                </h1>
                <p class="hero-sub">
                    Integrated platform for ambitious learners. Private data storage.
                    Sign up now to get started building your legacy.
                </p>
            </div>

            <div class="landing-form">
                <div id="form-login" class="auth-card">
                    <div class="auth-header">
                        <h2>Welcome Back</h2>
                    </div>
                    <form onsubmit="Auth.login(event)">
                        <div class="input-group">
                            <i class="fa-regular fa-envelope"></i>
                            <input type="email" id="log-email" class="input-std" placeholder="Email Address" required>
                        </div>
                        <div class="input-group">
                            <i class="fa-solid fa-lock"></i>
                            <input type="password" id="log-pass" class="input-std" placeholder="Password" required>
                        </div>
                        <div style="text-align: right; margin-bottom: 25px;">
                            <a href="#" onclick="Auth.toggle('forgot')"
                                style="color: var(--accent-color); font-weight: 600; font-size: 0.9rem;">Forgot
                                Password?</a>
                        </div>
                        <button type="submit" class="btn btn-primary w-full">Login</button>
                    </form>
                    <p style="text-align: center; margin-top: 20px; color: var(--text-secondary);">
                        No account? <a onclick="Auth.toggle('signup')"
                            style="color: var(--accent-color); cursor: pointer; font-weight: 700;">Sign Up</a>
                    </p>
                    <div style="text-align: center; margin-top: 30px; font-size: 0.8rem; color: #999;">By Benjamin
                        Nguyen</div>
                </div>

                <div id="form-signup" class="auth-card hidden">
                    <div class="auth-header">
                        <h2>Create New Account</h2>
                    </div>
                    <form onsubmit="Auth.signup(event)">
                        <div class="input-group">
                            <i class="fa-regular fa-user"></i>
                            <input type="text" id="reg-name" class="input-std" placeholder="Display Name" required>
                        </div>
                        <div class="input-group">
                            <i class="fa-regular fa-envelope"></i>
                            <input type="email" id="reg-email" class="input-std" placeholder="Email" required>
                        </div>
                        <div class="input-group">
                            <i class="fa-solid fa-lock"></i>
                            <input type="password" id="reg-pass" class="input-std" placeholder="Password" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-full">Create Account</button>
                    </form>
                    <p style="text-align: center; margin-top: 20px;">
                        Already have an account? <a onclick="Auth.toggle('login')"
                            style="color: var(--accent-color); cursor: pointer; font-weight: 700;">Login</a>
                    </p>
                </div>

                <div id="form-forgot" class="auth-card hidden">
                    <div class="auth-header">
                        <h2>Reset Password</h2>
                    </div>
                    <form onsubmit="Auth.resetPass(event)">
                        <div class="input-group">
                            <i class="fa-regular fa-envelope"></i>
                            <input type="email" id="reset-email" class="input-std" placeholder="Email Address" required>
                        </div>
                        <div class="input-group">
                            <i class="fa-solid fa-key"></i>
                            <input type="password" id="reset-pass" class="input-std" placeholder="New Password"
                                required>
                        </div>
                        <button type="submit" class="btn btn-primary w-full">Update Password</button>
                    </form>
                    <p style="text-align: center; margin-top: 20px;">
                        <a onclick="Auth.toggle('login')"
                            style="color: var(--accent-color); cursor: pointer; font-weight: 700;">Back to Login</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="app-shell" class="hidden w-full h-full">
        <aside class="sidebar">
            <div class="logo-landing" style="margin-bottom: 40px; font-size: 1.5rem;">
                <i class="fa-solid fa-shield-halved"></i> Spartan
            </div>
            <nav class="flex-col">
                <div class="nav-item active" onclick="Nav.to('piano', this)"><i class="fa-solid fa-music"
                        style="width: 20px;"></i> <span data-t="piano">Piano Lab</span></div>
                <div class="nav-item" onclick="Nav.to('flashcards', this)"><i class="fa-solid fa-layer-group"
                        style="width: 20px;"></i> <span data-t="flashcards">Knowledge Hub</span></div>
                <div class="nav-item" onclick="Nav.to('tasks', this)"><i class="fa-solid fa-list-check"
                        style="width: 20px;"></i> <span data-t="tasks">Task Arena</span></div>
            </nav>
            <div class="settings-widget">
                <div class="settings-btn" onclick="Lang.toggle()" title="Toggle Language"><i
                        class="fa-solid fa-globe"></i></div>
                <div class="settings-btn" onclick="Theme.toggle()" title="Toggle Theme"><i
                        class="fa-solid fa-circle-half-stroke"></i></div>
            </div>
            <div class="user-widget">
                <div class="user-avatar" id="app-avatar"
                    style="width: 40px; height: 40px; border-radius: 50%; background: var(--brand-gradient); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700;">
                    H</div>
                <div style="color:var(--text-primary);">
                    <div style="font-weight: 700;" id="app-username">Henry</div>
                    <div style="font-size: 0.75rem; opacity: 0.6;">Architect</div>
                </div>
                <i class="fa-solid fa-right-from-bracket"
                    style="margin-left: auto; cursor: pointer; opacity: 0.5; color:var(--text-primary);"
                    onclick="Auth.logout()"></i>
            </div>
        </aside>

        <main style="flex: 1; position: relative;">
            <div id="mod-piano" class="w-full h-full">
                <div class="piano-header font-head">
                    <div style="font-size: 1.2rem; font-weight: 700;"><i class="fa-solid fa-terminal"></i> AUDIO ENGINE
                    </div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">WebAudio API Active <i
                            class="fa-solid fa-circle-check"></i></div>
                </div>
                <div class="piano-stage">
                    <div class="piano-case">
                        <div style="margin-bottom: 30px; display: flex; gap: 20px; align-items: center;">
                            <label style="font-weight: 600; color: var(--text-secondary);">Volume</label><input
                                type="range" id="vol-slider" min="0" max="100" value="50">
                            <label style="font-weight: 600; color: var(--text-secondary);">Waveform</label>
                            <select id="wave-type" class="input-std" style="width: 120px; padding: 5px;">
                                <option value="sine">Grand (Sine)</option>
                                <option value="triangle">Soft (Tri)</option>
                                <option value="sawtooth">Synth (Saw)</option>
                            </select>
                            <button class="btn btn-secondary" onclick="Piano.openBindEditor()">Keybinds</button>
                        </div>
                        <div class="keys-wrapper" id="piano-keys"></div>
                    </div>
                </div>
            </div>

            <div id="mod-flashcards" class="hidden w-full h-full">
                <div class="fc-header">
                    <h2 class="font-head" style="color: var(--text-primary); font-size: 1.8rem;" data-t="hub_title">
                        Knowledge Hub</h2>
                    <div class="flex gap-10">
                        <button class="btn btn-secondary"
                            onclick="Modals.prompt('Join Deck', 'Enter Deck ID:', Shared.join)"
                            data-t="join">Join</button>
                        <button class="btn btn-primary"
                            onclick="Modals.prompt('New Deck', 'Deck Name:', FC.createFolder)" data-t="new_deck">+ New
                            Deck</button>
                    </div>
                </div>
                <div class="folder-grid" id="folder-grid"></div>

                <div id="fc-overview-panel" class="hidden">
                    <div class="fc-header" style="border-bottom: 1px solid var(--border-color);">
                        <div class="flex items-center gap-20">
                            <button class="btn btn-secondary" style="border:none;" onclick="FC.closeOverview()"><i
                                    class="fa-solid fa-arrow-left"></i></button>
                            <h2 class="font-head" style="color: var(--text-primary);" id="ov-title">Deck Name</h2>
                        </div>
                        <div class="flex gap-10">
                            <button class="btn btn-secondary" onclick="FC.shareCurrentDeck()"><i
                                    class="fa-solid fa-share-nodes"></i> Share</button>
                            <button class="btn btn-secondary" onclick="FC.startQuiz()"><i class="fa-solid fa-brain"></i>
                                Quiz</button>
                            <button class="btn btn-primary" onclick="FC.startStudy()" data-t="study">Start
                                Study</button>
                            <button class="btn btn-secondary" onclick="Modals.open('modal-add-card')">+ Add</button>
                        </div>
                    </div>
                    <div class="folder-grid" id="word-list"
                        style="grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));"></div>
                </div>

                <div id="study-overlay" class="hidden">
                    <div class="study-header">
                        <button class="btn btn-secondary"
                            style="background:rgba(255,255,255,0.1); color:white; border:none;"
                            onclick="FC.closeStudy()">Exit</button>
                        <div style="color: white; font-weight: 700;" id="st-count">1 / 10</div>
                        <button class="btn btn-secondary"
                            style="background:rgba(255,255,255,0.1); color:white; border:none;"
                            onclick="FC.shareCurrentDeck()">Share</button>
                    </div>
                    <div id="mode-flip" class="flashcard-stage">
                        <div class="card-3d" onclick="this.classList.toggle('flipped')">
                            <div class="card-face face-front">
                                <div id="st-img-container"></div>
                                <div class="term-text" id="st-q">Question</div>
                                <div style="font-size:0.9rem; color:gray; margin-top:10px;">Click to flip</div>
                            </div>
                            <div class="card-face face-back">
                                <div class="term-text" id="st-a">Answer</div>
                            </div>
                        </div>
                        <div class="flex gap-20" style="margin-top: 40px;">
                            <button class="btn btn-secondary"
                                style="background:rgba(255,255,255,0.1); color:white; border:none;"
                                onclick="FC.nav(-1)">Prev</button>
                            <button class="btn btn-primary" onclick="FC.nav(1)">Next</button>
                        </div>
                    </div>
                    <div id="mode-quiz" class="flashcard-stage hidden">
                        <h2 class="font-head" style="font-size: 3rem; color: white; margin-bottom: 40px;" id="qz-q">?
                        </h2>
                        <div id="qz-reveal" class="hidden flex flex-col items-center">
                            <p style="font-size: 1.5rem; color: var(--status-success); margin-bottom: 30px;" id="qz-a">
                                ...</p>
                            <div class="flex gap-20">
                                <button class="btn btn-secondary"
                                    style="color: var(--status-danger); border-color:var(--status-danger);"
                                    onclick="FC.ans(false)">Forgot</button>
                                <button class="btn btn-secondary"
                                    style="color: var(--status-success); border-color:var(--status-success);"
                                    onclick="FC.ans(true)">Recall</button>
                            </div>
                        </div>
                        <button id="qz-btn-show" class="btn btn-primary" onclick="FC.showQuiz()">Reveal</button>
                    </div>
                </div>
            </div>

            <div id="mod-tasks" class="hidden w-full h-full">
                <div class="task-sidebar">
                    <div style="font-size: 0.7rem; font-weight: 800; color: var(--text-secondary); margin-bottom: 15px; letter-spacing: 1px;"
                        data-t="proj_label">PROJECTS</div>
                    <div id="project-list"></div>
                    <button class="btn btn-secondary w-full" style="margin-top: 15px; border-style: dashed;"
                        onclick="Modals.prompt('New Project','Project Name:', Tasks.createProject)" data-t="new_proj">+
                        New Project</button>
                </div>
                <div class="task-main">
                    <div class="task-board-header">
                        <div>
                            <h2 class="font-head" style="font-size: 1.8rem; color: var(--text-primary);"
                                id="proj-header">Projects</h2>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">Workspace: Main</p>
                        </div>
                        <div class="flex gap-10">
                            <button class="btn btn-secondary" onclick="Tasks.share()"><i
                                    class="fa-solid fa-share-nodes"></i> Share Project</button>
                            <button class="btn btn-primary"
                                onclick="Modals.prompt('New Task','Task Name:', Tasks.addTask)" data-t="new_task">+ New
                                Task</button>
                        </div>
                    </div>
                    <div class="task-list-container">
                        <div class="task-cols">
                            <div></div>
                            <div>Name</div>
                            <div>Assignee</div>
                            <div>Due Date</div>
                            <div>Priority</div>
                        </div>
                        <div id="task-rows"></div>
                    </div>
                    <div id="task-panel" class="task-detail-panel">
                        <div class="flex justify-between" style="margin-bottom: 30px;">
                            <div class="flex gap-10">
                                <button class="btn btn-secondary"
                                    style="color: var(--status-success); border-color: var(--status-success);"
                                    onclick="Tasks.complete()"><i class="fa-solid fa-check"></i></button>
                                <button class="btn btn-danger"
                                    onclick="Modals.confirm('Delete Task', 'Are you sure?', Tasks.deleteTask)"><i
                                        class="fa-solid fa-trash"></i></button>
                            </div>
                            <button class="btn btn-secondary" style="border:none;" onclick="Tasks.closePanel()"><i
                                    class="fa-solid fa-xmark"></i></button>
                        </div>
                        <input type="text" id="edit-title" class="input-std"
                            style="background: transparent; border: none; font-size: 1.5rem; font-weight: 700; padding: 0; margin-bottom: 20px;"
                            placeholder="Task Name">

                        <div class="input-wrapper">
                            <input type="file" id="task-img" class="hidden-input" accept="image/*"
                                onchange="Tasks.handleTaskImage(this)">
                            <div class="file-upload-box" id="task-img-label"
                                onclick="document.getElementById('task-img').click()">
                                <i class="fa-solid fa-paperclip"></i>
                                <span>Attach Image</span>
                            </div>
                            <div class="image-preview-wrapper" id="task-preview-container" style="display:none;">
                                <img id="task-img-preview" class="card-img-preview">
                                <button class="btn-remove-image" onclick="Tasks.removeImage()" id="task-img-remove"><i
                                        class="fa-solid fa-xmark"></i></button>
                            </div>
                        </div>

                        <div
                            style="display: grid; grid-template-columns: 100px 1fr; gap: 20px; align-items: center; margin-bottom:30px;">
                            <span style="color: var(--text-secondary);">Assignee</span>
                            <input type="text" id="edit-assignee" class="input-std" style="padding:6px;"
                                placeholder="Assign to...">

                            <span style="color: var(--text-secondary);">Due Date</span><input type="date" id="edit-date"
                                class="input-std" style="width: auto; padding: 6px;">
                            <span style="color: var(--text-secondary);">Priority</span>
                            <select id="edit-priority" class="input-std" style="width: auto; padding: 6px;">
                                <option value="High">High</option>
                                <option value="Med">Medium</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>
                        <h4 style="color: var(--text-secondary); margin-bottom: 10px;">Description</h4>
                        <textarea id="edit-desc" class="input-std" style="height: 200px; resize: none;"
                            placeholder="Details..."></textarea>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="modal-prompt" class="modal-overlay">
        <div class="modal-box">
            <h2 id="prompt-title" style="font-size:1.5rem; margin-bottom:15px; font-weight:700;">Input</h2>
            <div class="input-wrapper"><label id="prompt-label"
                    style="display:block; margin-bottom:5px;">Value</label><input id="prompt-input" class="input-std">
            </div>
            <div class="flex justify-between" style="margin-top:20px;"><button class="btn btn-secondary"
                    onclick="Modals.close()">Cancel</button><button class="btn btn-primary"
                    id="prompt-confirm">Confirm</button></div>
        </div>
    </div>
    <div id="modal-confirm" class="modal-overlay">
        <div class="modal-box">
            <h2 id="confirm-title"
                style="font-size:1.5rem; margin-bottom:10px; font-weight:700; color:var(--status-danger)">Confirm</h2>
            <p id="confirm-msg" style="margin-bottom:20px;">Are you sure?</p>
            <div class="flex justify-between"><button class="btn btn-secondary"
                    onclick="Modals.close()">Cancel</button><button class="btn btn-danger"
                    id="confirm-btn">Delete</button></div>
        </div>
    </div>
    <div id="modal-keybinds" class="modal-overlay">
        <div class="modal-box">
            <h2 style="font-size:1.5rem; margin-bottom:15px;">Piano Keybinds</h2>
            <div id="binds-list" class="bind-grid"></div>
            <div class="flex justify-between"
                style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px;"><button
                    class="btn btn-secondary" onclick="Modals.close()">Cancel</button><button class="btn btn-primary"
                    onclick="Piano.saveBinds()">Save</button></div>
        </div>
    </div>
    <div id="modal-add-card" class="modal-overlay">
        <div class="modal-box">
            <h2 style="font-size:1.5rem; font-weight:700; margin-bottom:20px;">New Flashcard</h2>
            <div class="input-wrapper"><input id="new-q" class="input-std" placeholder="Front (Question)"></div>
            <div class="input-wrapper"><textarea id="new-a" class="input-std" style="height: 100px;"
                    placeholder="Back (Answer)"></textarea></div>
            <div class="input-wrapper">
                <input type="file" id="new-img" class="hidden-input" accept="image/*"
                    onchange="FC.handleFileSelect(this, 'add-preview', 'add-label', 'add-preview-container', 'add-remove-btn')">
                <div class="file-upload-box" id="add-label" onclick="document.getElementById('new-img').click()"><i
                        class="fa-solid fa-cloud-arrow-up"></i><span>Choose Image</span></div>
                <div class="image-preview-wrapper" id="add-preview-container">
                    <img id="add-preview" class="card-img-preview">
                    <button class="btn-remove-image" id="add-remove-btn"
                        onclick="FC.removeImage('new-img', 'add-preview', 'add-label', 'add-preview-container')"><i
                            class="fa-solid fa-xmark"></i></button>
                </div>
            </div>
            <div class="flex justify-between" style="margin-top: 20px;"><button class="btn btn-secondary"
                    onclick="Modals.close()">Cancel</button><button class="btn btn-primary"
                    onclick="FC.submitCard()">Save Card</button></div>
        </div>
    </div>
    <div id="modal-edit-card" class="modal-overlay">
        <div class="modal-box">
            <h2 style="font-size:1.5rem; font-weight:700; margin-bottom:20px;">Edit Card</h2>
            <div class="input-wrapper"><input id="edit-q-input" class="input-std" placeholder="Front (Question)"></div>
            <div class="input-wrapper"><textarea id="edit-a-input" class="input-std" style="height: 100px;"
                    placeholder="Back (Answer)"></textarea></div>
            <div class="input-wrapper">
                <input type="file" id="edit-img" class="hidden-input" accept="image/*"
                    onchange="FC.handleFileSelect(this, 'preview-edit-img', 'edit-label', 'edit-preview-container', 'edit-remove-btn')">
                <div class="file-upload-box" id="edit-label" onclick="document.getElementById('edit-img').click()"><i
                        class="fa-solid fa-camera"></i><span>Update Image</span></div>
                <div class="image-preview-wrapper" id="edit-preview-container">
                    <img id="preview-edit-img" class="card-img-preview">
                    <button class="btn-remove-image" id="edit-remove-btn"
                        onclick="FC.removeImage('edit-img', 'preview-edit-img', 'edit-label', 'edit-preview-container')"><i
                            class="fa-solid fa-xmark"></i></button>
                </div>
            </div>
            <div class="flex justify-between" style="margin-top: 20px;"><button class="btn btn-secondary"
                    onclick="Modals.close()">Cancel</button><button class="btn btn-primary"
                    onclick="FC.saveEdit()">Update</button></div>
        </div>
    </div>
    <div id="modal-share" class="modal-overlay">
        <div class="modal-box" style="text-align: center;">
            <i class="fa-solid fa-lock" style="font-size: 3rem; color: var(--status-info); margin-bottom: 20px;"></i>
            <h2 style="margin-bottom:10px;">Secure Share</h2>
            <div
                style="background: var(--bg-main); padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left; color: var(--text-primary); border: 1px solid var(--border-color);">
                <div style="color: var(--text-secondary); font-size: 0.8rem;">ID</div>
                <div style="font-family: monospace; font-size: 1.2rem; color: var(--accent-color); margin-bottom:10px;"
                    id="sh-id">...</div>
                <div style="color: var(--text-secondary); font-size: 0.8rem;">PASSWORD</div>
                <div style="font-family: monospace; font-size: 1.2rem; color: var(--status-success);" id="sh-pass">...
                </div>
            </div>
            <button class="btn btn-primary w-full" onclick="Modals.close()">Done</button>
        </div>
    </div>
    <div id="modal-join" class="modal-overlay">
        <div class="modal-box">
            <h2 style="margin-bottom:20px;">Join Resource</h2>
            <div class="input-wrapper"><input id="join-id" class="input-std" placeholder="Enter ID"></div>
            <div class="input-wrapper"><input id="join-pass" type="password" class="input-std"
                    placeholder="Enter Password"></div>
            <button class="btn btn-primary w-full" onclick="Shared.join()">Connect</button>
            <button class="btn btn-secondary w-full" style="margin-top: 10px; border:none;"
                onclick="Modals.close()">Cancel</button>
        </div>
    </div>

    <script>
        /* --- CONSTANTS --- */
        const TEXT = {
            en: { piano: 'Piano Lab', flashcards: 'Knowledge Hub', tasks: 'Task Arena', proj_label: 'PROJECTS', new_proj: '+ New Project', new_task: '+ New Task', join: 'Join', new_deck: '+ New Deck', study: 'Start Study', hub_title: 'Knowledge Hub' },
            vi: { piano: 'Phng Piano', flashcards: 'Kho Tri Thc', tasks: 'Qun L Task', proj_label: 'D N', new_proj: '+ D n Mi', new_task: '+ Task Mi', join: 'Tham Gia', new_deck: '+ B Mi', study: 'Bt u Hc', hub_title: 'Kho Tri Thc' }
        };

        const Notify = {
            show: (msg, type = 'success') => {
                const toast = document.createElement('div'); toast.className = `toast ${type}`;
                toast.innerHTML = `<i class="fa-solid ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}" style="color:${type === 'success' ? '#10B981' : type === 'error' ? '#EF4444' : '#3B82F6'}"></i> <span>${msg}</span>`;
                document.getElementById('toast-container').appendChild(toast); setTimeout(() => toast.remove(), 3000);
            }
        };

        const Modals = {
            open: (id) => document.getElementById(id).classList.add('active'),
            close: () => document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active')),
            prompt: (title, label, callback) => {
                document.getElementById('prompt-title').innerText = title; document.getElementById('prompt-label').innerText = label;
                const input = document.getElementById('prompt-input'); input.value = ''; Modals.open('modal-prompt'); input.focus();
                document.getElementById('prompt-confirm').onclick = () => { if (input.value.trim()) { callback(input.value.trim()); Modals.close(); } else Notify.show('Field cannot be empty', 'error'); };
            },
            confirm: (title, msg, callback) => {
                document.getElementById('confirm-title').innerText = title; document.getElementById('confirm-msg').innerText = msg;
                Modals.open('modal-confirm'); document.getElementById('confirm-btn').onclick = () => { callback(); Modals.close(); };
            }
        };

        /* --- STATE --- */
        const DB = {
            saveUser: (u) => localStorage.setItem('u_' + u.email, JSON.stringify(u)),
            getUser: (e) => JSON.parse(localStorage.getItem('u_' + e)),
            init: () => {
                if (!localStorage.getItem('decks')) localStorage.setItem('decks', JSON.stringify([{ id: 1, name: 'English C1', cards: [{ q: 'Ambition', a: 'Hoi bo' }] }]));
                if (!localStorage.getItem('projects')) localStorage.setItem('projects', JSON.stringify([{ id: 1, name: 'Launch Alpha', tasks: [{ id: 1, title: 'Setup Server', done: false, date: '2025-12-01', priority: 'High', assignee: 'Henry' }] }]));
                if (!localStorage.getItem('pianoBinds')) localStorage.setItem('pianoBinds', JSON.stringify({ 'C3': 'z', 'C#3': 's', 'D3': 'x', 'D#3': 'd', 'E3': 'c', 'F3': 'v', 'F#3': 'g', 'G3': 'b', 'G#3': 'h', 'A3': 'n', 'A#3': 'j', 'B3': 'm', 'C4': 'q', 'C#4': '2', 'D4': 'w', 'D#4': '3', 'E4': 'e', 'F4': 'r', 'F#4': '5', 'G4': 't', 'G#4': '6', 'A4': 'y', 'A#4': '7', 'B4': 'u', 'C5': 'i', 'C#5': '9', 'D5': 'o', 'D#5': '0', 'E5': 'p' }));
            },
            getData: (k) => JSON.parse(localStorage.getItem(k)),
            setData: (k, v) => localStorage.setItem(k, JSON.stringify(v))
        };

        const State = { decks: [], projects: [], currD: 0, currC: 0, currP: 0, editCardIdx: null, activeTask: null, audioCtx: null, keyMap: {}, lang: 'en', theme: 'light' };
        const fileToBase64 = (file) => new Promise((r, j) => { const reader = new FileReader(); reader.onload = () => r(reader.result); reader.readAsDataURL(file); });

        /* --- SETTINGS --- */
        const Lang = { toggle: () => { State.lang = State.lang === 'en' ? 'vi' : 'en'; document.querySelectorAll('[data-t]').forEach(el => el.innerText = TEXT[State.lang][el.dataset.t]); Notify.show('Language changed'); } };
        const Theme = { toggle: () => { State.theme = State.theme === 'light' ? 'dark' : 'light'; document.body.className = `theme-${State.theme}`; Notify.show('Theme updated'); } };

        /* --- AUTH --- */
        const Auth = {
            toggle: (mode) => { ['form-login', 'form-signup', 'form-forgot'].forEach(id => document.getElementById(id).classList.add('hidden')); document.getElementById('form-' + mode).classList.remove('hidden'); },
            signup: (e) => { e.preventDefault(); DB.saveUser({ name: document.getElementById('reg-name').value, email: document.getElementById('reg-email').value, pass: document.getElementById('reg-pass').value }); Notify.show('Account Created!'); Auth.toggle('login'); },
            login: (e) => {
                e.preventDefault(); const u = DB.getUser(document.getElementById('log-email').value);
                if (u && u.pass === document.getElementById('log-pass').value) {
                    document.getElementById('app-username').innerText = u.name; document.getElementById('app-avatar').innerText = u.name[0];
                    document.getElementById('auth-screen').style.opacity = 0;
                    setTimeout(() => { document.getElementById('auth-screen').classList.add('hidden'); document.getElementById('app-shell').classList.remove('hidden'); setTimeout(() => document.getElementById('app-shell').style.opacity = 1, 50); }, 400);
                    DB.init(); State.decks = DB.getData('decks'); State.projects = DB.getData('projects'); State.keyMap = DB.getData('pianoBinds');
                    Piano.render(); Piano.initKeys(); FC.renderHub(); Tasks.renderSidebar();
                    Notify.show('Welcome back, ' + u.name);
                } else Notify.show('Invalid Credentials', 'error');
            },
            resetPass: (e) => { e.preventDefault(); const u = DB.getUser(document.getElementById('reset-email').value); if (u) { u.pass = document.getElementById('reset-pass').value; DB.saveUser(u); Notify.show('Password updated!'); Auth.toggle('login'); } else Notify.show('Email not found', 'error'); },
            logout: () => location.reload()
        };

        const Nav = { to: (tab, el) => { document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active')); el.classList.add('active');['mod-piano', 'mod-flashcards', 'mod-tasks'].forEach(id => document.getElementById(id).classList.add('hidden')); document.getElementById('mod-' + tab).classList.remove('hidden'); } };

        /* --- PIANO --- */
        const Piano = {
            notes: [{ n: 'C3', t: 'w' }, { n: 'C#3', t: 'b' }, { n: 'D3', t: 'w' }, { n: 'D#3', t: 'b' }, { n: 'E3', t: 'w' }, { n: 'F3', t: 'w' }, { n: 'F#3', t: 'b' }, { n: 'G3', t: 'w' }, { n: 'G#3', t: 'b' }, { n: 'A3', t: 'w' }, { n: 'A#3', t: 'b' }, { n: 'B3', t: 'w' }, { n: 'C4', t: 'w' }, { n: 'C#4', t: 'b' }, { n: 'D4', t: 'w' }, { n: 'D#4', t: 'b' }, { n: 'E4', t: 'w' }, { n: 'F4', t: 'w' }, { n: 'F#4', t: 'b' }, { n: 'G4', t: 'w' }, { n: 'G#4', t: 'b' }, { n: 'A4', t: 'w' }, { n: 'A#4', t: 'b' }, { n: 'B4', t: 'w' }, { n: 'C5', t: 'w' }, { n: 'C#5', t: 'b' }, { n: 'D5', t: 'w' }, { n: 'D#5', t: 'b' }, { n: 'E5', t: 'w' }],
            initKeys: () => { document.addEventListener('keydown', Piano.handleKeyDown); document.addEventListener('keyup', Piano.handleKeyUp); },
            render: () => {
                const box = document.getElementById('piano-keys'); box.innerHTML = ''; let pos = 0;
                Piano.notes.forEach(k => {
                    const el = document.createElement('div'); el.dataset.note = k.n;
                    if (k.t === 'w') { el.className = 'key key-white'; el.innerHTML = `<span class="key-label">${State.keyMap[k.n] || ''}</span>`; pos += 50; }
                    else { el.className = 'key key-black'; el.style.left = (pos - 15) + 'px'; el.innerHTML = `<span class="key-label">${State.keyMap[k.n] || ''}</span>`; }
                    el.onmousedown = () => Piano.play(k.n, el); box.appendChild(el);
                });
            },
            play: (note, el) => {
                if (!State.audioCtx) State.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = State.audioCtx.createOscillator(); const gain = State.audioCtx.createGain();
                const freqs = { 'C3': 130.8, 'C#3': 138.6, 'D3': 146.8, 'D#3': 155.6, 'E3': 164.8, 'F3': 174.6, 'F#3': 185.0, 'G3': 196.0, 'G#3': 207.6, 'A3': 220.0, 'A#3': 233.1, 'B3': 246.9, 'C4': 261.6, 'C#4': 277.2, 'D4': 293.7, 'D#4': 311.1, 'E4': 329.6, 'F4': 349.2, 'F#4': 370.0, 'G4': 392.0, 'G#4': 415.3, 'A4': 440.0, 'A#4': 466.2, 'B4': 493.9, 'C5': 523.3, 'C#5': 554.4, 'D5': 587.3, 'D#5': 622.3, 'E5': 659.3 };
                osc.type = document.getElementById('wave-type').value; osc.frequency.value = freqs[note];
                const now = State.audioCtx.currentTime; const vol = document.getElementById('vol-slider').value / 100;
                gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(vol, now + 0.01); gain.gain.exponentialRampToValueAtTime(0.001, now + 1);
                osc.connect(gain); gain.connect(State.audioCtx.destination); osc.start(); osc.stop(now + 1);
                if (el) { el.classList.add('active'); setTimeout(() => el.classList.remove('active'), 200); }
            },
            handleKeyDown: (e) => { if (e.repeat || document.querySelector('.modal-overlay.active')) return; const note = Object.keys(State.keyMap).find(key => State.keyMap[key] === e.key.toLowerCase()); if (note) Piano.play(note, document.querySelector(`[data-note="${note}"]`)); },
            handleKeyUp: (e) => { },
            openBindEditor: () => {
                const list = document.getElementById('binds-list'); list.innerHTML = '';
                Piano.notes.forEach(note => {
                    const row = document.createElement('div'); row.className = 'bind-row';
                    row.innerHTML = `<span class="bind-key">${note.n}</span> <input class="bind-input" data-note="${note.n}" value="${State.keyMap[note.n] || ''}" maxlength="1">`;
                    list.appendChild(row);
                }); Modals.open('modal-keybinds');
            },
            saveBinds: () => {
                const newMap = {}; document.querySelectorAll('.bind-input').forEach(inp => { if (inp.value) newMap[inp.dataset.note] = inp.value.toLowerCase(); });
                State.keyMap = newMap; DB.setData('pianoBinds', newMap); Piano.render(); Modals.close(); Notify.show('Keybinds saved');
            }
        };

        /* --- FLASHCARDS --- */
        const FC = {
            renderHub: () => {
                document.getElementById('folder-grid').innerHTML = State.decks.map((f, i) => `
                    <div class="folder-card" onclick="FC.openOverview(${i})"><div style="font-size: 2.5rem; color: var(--accent-color); margin-bottom: 10px;"></div><div><h3 style="color:var(--text-primary); font-size:1.2rem;">${f.name}</h3><p style="color:var(--text-secondary);">${f.cards.length} cards</p></div></div>
                `).join('');
            },
            createFolder: (name) => {
                const id = Date.now();
                State.decks.push({ id: id, name: name, cards: [] });
                // Auto create linked task project
                State.projects.push({ id: id, name: name, tasks: [] });
                DB.setData('decks', State.decks);
                DB.setData('projects', State.projects);
                FC.renderHub();
                Tasks.renderSidebar(); // Update task sidebar
                Notify.show('Deck & Project created');
            },
            openOverview: (i) => {
                State.currD = i; document.getElementById('fc-overview-panel').classList.remove('hidden');
                document.getElementById('ov-title').innerText = State.decks[i].name;
                document.getElementById('word-list').innerHTML = State.decks[i].cards.map((c, idx) => `
                    <div class="mini-card-scene" onclick="this.querySelector('.mini-card').classList.toggle('flipped')">
                        <div class="mini-card">
                            <div class="mini-face front">${c.img ? `<img src="${c.img}" class="card-img-display">` : ''}<div>${c.q}</div></div>
                            <div class="mini-face back">${c.a}</div>
                        </div>
                        <button class="btn-edit-float" onclick="FC.editCard(${idx}, event)"><i class="fa-solid fa-pen"></i></button>
                    </div>
                `).join('');
            },
            closeOverview: () => document.getElementById('fc-overview-panel').classList.add('hidden'),

            handleFileSelect: (input, previewId, labelId, containerId, removeBtnId) => {
                const file = input.files[0]; const label = document.getElementById(labelId); const preview = document.getElementById(previewId); const container = document.getElementById(containerId); const removeBtn = document.getElementById(removeBtnId);
                if (file) {
                    label.style.display = 'none'; container.style.display = 'block';
                    const reader = new FileReader(); reader.onload = (e) => { preview.src = e.target.result; if (removeBtn) removeBtn.style.display = 'flex'; }; reader.readAsDataURL(file);
                }
            },
            removeImage: (inputId, previewId, labelId, containerId) => {
                document.getElementById(inputId).value = ''; document.getElementById(previewId).src = '';
                document.getElementById(containerId).style.display = 'none'; document.getElementById(labelId).style.display = 'block';
                // Important: clear the img property in state when saving if needed, logic handled in save
            },
            editCard: (idx, e) => {
                e.stopPropagation(); State.editCardIdx = idx; const c = State.decks[State.currD].cards[idx];
                document.getElementById('edit-q-input').value = c.q; document.getElementById('edit-a-input').value = c.a;

                const hasImg = !!c.img;
                document.getElementById('edit-label').style.display = hasImg ? 'none' : 'block';
                document.getElementById('edit-preview-container').style.display = hasImg ? 'block' : 'none';
                document.getElementById('preview-edit-img').src = c.img || '';
                if (hasImg) document.getElementById('edit-remove-btn').style.display = 'flex';

                Modals.open('modal-edit-card');
            },
            saveEdit: async () => {
                const q = document.getElementById('edit-q-input').value; const a = document.getElementById('edit-a-input').value;
                const file = document.getElementById('edit-img').files[0];
                let img = document.getElementById('preview-edit-img').src;

                // If container is hidden, image was removed
                if (document.getElementById('edit-preview-container').style.display === 'none') {
                    img = null;
                } else if (file) {
                    img = await fileToBase64(file);
                }

                const finalImg = (img && img.includes('base64')) ? img : (img && img.length > 100 ? img : null);

                if (q && a) { State.decks[State.currD].cards[State.editCardIdx] = { q, a, img: finalImg }; DB.setData('decks', State.decks); Modals.close(); FC.openOverview(State.currD); Notify.show('Card updated'); }
            },
            startStudy: () => {
                if (State.decks[State.currD].cards.length === 0) return Notify.show('Empty Deck', 'info');
                State.currC = 0; document.getElementById('study-overlay').classList.remove('hidden'); document.getElementById('mode-flip').classList.remove('hidden'); document.getElementById('mode-quiz').classList.add('hidden'); FC.updCard();
            },
            closeStudy: () => document.getElementById('study-overlay').classList.add('hidden'),
            updCard: () => {
                const c = State.decks[State.currD].cards[State.currC];
                document.getElementById('st-img-container').innerHTML = c.img ? `<img src="${c.img}" class="card-img-display">` : '';
                document.getElementById('st-q').innerText = c.q; document.getElementById('st-a').innerText = c.a;
                document.getElementById('st-count').innerText = `${State.currC + 1} / ${State.decks[State.currD].cards.length}`;
                document.querySelector('.card-3d').classList.remove('flipped');
            },
            nav: (d) => { let n = State.currC + d; if (n >= 0 && n < State.decks[State.currD].cards.length) { State.currC = n; FC.updCard(); } },
            startQuiz: () => {
                if (State.decks[State.currD].cards.length === 0) return Notify.show('Empty Deck', 'info');
                State.currC = 0; document.getElementById('study-overlay').classList.remove('hidden'); document.getElementById('mode-flip').classList.add('hidden'); document.getElementById('mode-quiz').classList.remove('hidden'); FC.loadQuiz();
            },
            loadQuiz: () => {
                const c = State.decks[State.currD].cards[State.currC]; document.getElementById('qz-q').innerText = c.q; document.getElementById('qz-a').innerText = c.a;
                document.getElementById('qz-reveal').classList.add('hidden'); document.getElementById('qz-btn-show').classList.remove('hidden');
            },
            showQuiz: () => { document.getElementById('qz-reveal').classList.remove('hidden'); document.getElementById('qz-btn-show').classList.add('hidden'); },
            ans: () => { if (State.currC < State.decks[State.currD].cards.length - 1) { State.currC++; FC.loadQuiz(); } else { Notify.show('Session Done!'); FC.closeStudy(); } },
            submitCard: async () => {
                const q = document.getElementById('new-q').value; const a = document.getElementById('new-a').value;
                const file = document.getElementById('new-img').files[0]; let img = null; if (file) img = await fileToBase64(file);
                if (q && a) {
                    State.decks[State.currD].cards.push({ q, a, img }); DB.setData('decks', State.decks);
                    document.getElementById('new-q').value = ''; document.getElementById('new-a').value = '';
                    FC.removeImage('new-img', 'add-preview', 'add-label', 'add-preview-container');
                    Modals.close(); FC.openOverview(State.currD); Notify.show('Card added');
                }
            },
            shareCurrentDeck: () => Shared.share('bundle', State.decks[State.currD]) // Change type to 'bundle' to imply linked data
        };

        /* --- TASKS --- */
        const Tasks = {
            renderSidebar: () => {
                document.getElementById('project-list').innerHTML = State.projects.map((p, i) => `
                    <div class="project-item ${i === State.currP ? 'active' : ''}" onclick="Tasks.switch(${i})"><div style="width:8px; height:8px; border-radius:50%; background:${i === 0 ? 'orange' : 'purple'}"></div> ${p.name}</div>
                `).join(''); Tasks.renderBoard();
            },
            switch: (i) => { State.currP = i; Tasks.renderSidebar(); },
            createProject: (name) => { if (name) { State.projects.push({ id: Date.now(), name: name, tasks: [] }); DB.setData('projects', State.projects); Tasks.renderSidebar(); Notify.show('Project created'); } },
            renderBoard: () => {
                const p = State.projects[State.currP];
                document.getElementById('proj-header').innerText = p.name;
                document.getElementById('task-rows').innerHTML = p.tasks.map(t => `
                    <div class="task-row ${t.done ? 'completed' : ''}" onclick="Tasks.openPanel(${t.id})">
                        <div class="checkbox"><i class="fa-solid fa-check" style="font-size:10px; color:${t.done ? 'var(--text-primary)' : 'transparent'}"></i></div>
                        <span style="font-weight:500; color:var(--text-primary);">${t.title} ${t.img ? '<i class="fa-solid fa-paperclip" style="font-size:0.7rem; color:var(--text-secondary); margin-left:5px;"></i>' : ''}</span>
                        <div style="color:gray; font-size:0.8rem;">${t.assignee || 'Unassigned'}</div>
                        <div style="color:${t.done ? 'var(--text-secondary)' : '#EF4444'}">${t.date}</div>
                        <div style="background:rgba(239,68,68,0.2); color:#EF4444; padding:4px 8px; border-radius:4px; font-size:0.7rem; text-align:center;">${t.priority}</div>
                    </div>
                `).join('');
            },
            addTask: (name) => {
                if (name) {
                    State.projects[State.currP].tasks.push({ id: Date.now(), title: name, done: false, priority: 'Low', date: '2025-12-01', assignee: 'Me' });
                    DB.setData('projects', State.projects); Tasks.renderBoard(); Notify.show('Task added');
                }
            },
            openPanel: (id) => {
                const t = State.projects[State.currP].tasks.find(x => x.id === id); State.activeTask = t;
                document.getElementById('edit-title').value = t.title; document.getElementById('edit-date').value = t.date;
                document.getElementById('edit-priority').value = t.priority; document.getElementById('edit-assignee').value = t.assignee || '';

                const hasImg = !!t.img;
                document.getElementById('task-img-label').style.display = hasImg ? 'none' : 'block';
                document.getElementById('task-preview-container').style.display = hasImg ? 'block' : 'none';
                document.getElementById('task-img-preview').src = t.img || '';
                if (hasImg) document.getElementById('task-img-remove').style.display = 'flex';

                document.getElementById('task-panel').classList.add('open');
            },
            closePanel: () => {
                const t = State.activeTask;
                if (t) {
                    t.title = document.getElementById('edit-title').value; t.date = document.getElementById('edit-date').value;
                    t.priority = document.getElementById('edit-priority').value; t.assignee = document.getElementById('edit-assignee').value;

                    let img = document.getElementById('task-img-preview').src;
                    if (document.getElementById('task-preview-container').style.display === 'none') img = null;
                    t.img = (img && img.includes('base64')) ? img : null;

                    DB.setData('projects', State.projects); Tasks.renderBoard();
                }
                document.getElementById('task-panel').classList.remove('open');
            },
            handleTaskImage: async (input) => {
                const file = input.files[0];
                if (file) {
                    const img = await fileToBase64(file);
                    document.getElementById('task-img-preview').src = img;
                    document.getElementById('task-img-label').style.display = 'none';
                    document.getElementById('task-preview-container').style.display = 'block';
                    document.getElementById('task-img-remove').style.display = 'flex';
                }
            },
            removeImage: () => {
                FC.removeImage('task-img', 'task-img-preview', 'task-img-label', 'task-preview-container');
            },
            deleteTask: () => {
                const idx = State.projects[State.currP].tasks.findIndex(x => x.id === State.activeTask.id);
                State.projects[State.currP].tasks.splice(idx, 1);
                DB.setData('projects', State.projects); Tasks.closePanel(); Notify.show('Task deleted', 'error');
            },
            complete: () => { State.activeTask.done = !State.activeTask.done; DB.setData('projects', State.projects); Tasks.closePanel(); Notify.show('Status updated'); },
            share: () => Shared.share('project', State.projects[State.currP])
        };

        const Shared = {
            share: (type, data) => {
                Modals.prompt('Secure Share', 'Set Password:', (pass) => {
                    const id = "SPF-" + Math.floor(Math.random() * 9999);

                    // Bundle Logic: If sharing deck, find linked project. If sharing project, find linked deck.
                    let payload = { type, data, pass };

                    if (type === 'bundle' || type === 'deck') {
                        // 'data' is the deck
                        const linkedProject = State.projects.find(p => p.id === data.id);
                        payload = { type: 'bundle', deck: data, project: linkedProject, pass };
                    }

                    localStorage.setItem(id, JSON.stringify(payload));
                    document.getElementById('sh-id').innerText = id; document.getElementById('sh-pass').innerText = pass;
                    Modals.open('modal-share');
                });
            },
            join: (idStr) => {
                if (!idStr) return Notify.show('ID required', 'error');
                const stored = JSON.parse(localStorage.getItem(idStr));
                if (stored) {
                    Modals.prompt('Join Resource', 'Enter Password:', (pass) => {
                        if (stored.pass !== pass) return Notify.show("Incorrect Password", 'error');

                        // Handle Bundle
                        if (stored.type === 'bundle') {
                            if (stored.deck) {
                                State.decks.push({ ...stored.deck, name: stored.deck.name + ' (Shared)' });
                                DB.setData('decks', State.decks); FC.renderHub();
                            }
                            if (stored.project) {
                                // Link IDs might change in real app, but here we just push
                                State.projects.push({ ...stored.project, name: stored.project.name + ' (Shared)' });
                                DB.setData('projects', State.projects); Tasks.renderSidebar();
                            }
                            Notify.show('Joined Bundle Successfully!');
                        }
                        // Handle legacy single types just in case
                        else if (stored.type === 'deck') {
                            State.decks.push({ ...stored.data, name: stored.data.name + ' (Shared)' }); DB.setData('decks', State.decks); FC.renderHub(); Notify.show('Joined Deck!');
                        }
                        else if (stored.type === 'project') {
                            State.projects.push({ ...stored.data, name: stored.data.name + ' (Shared)' }); DB.setData('projects', State.projects); Tasks.renderSidebar(); Notify.show('Joined Project!');
                        }
                        Modals.close();
                    });
                } else Notify.show('Invalid ID', 'error');
            }
        };

        /* --- AI CHATBOT --- */
        (function () { if (!window.chatbase || window.chatbase("getState") !== "initialized") { window.chatbase = (...arguments) => { if (!window.chatbase.q) { window.chatbase.q = [] } window.chatbase.q.push(arguments) }; window.chatbase = new Proxy(window.chatbase, { get(target, prop) { if (prop === "q") { return target.q } return (...args) => target(prop, ...args) } }) } const onLoad = function () { const script = document.createElement("script"); script.src = "https://www.chatbase.co/embed.min.js"; script.id = "RB-GhOWlWGCnxZOsizoFz"; script.domain = "www.chatbase.co"; document.body.appendChild(script) }; if (document.readyState === "complete") { onLoad() } else { window.addEventListener("load", onLoad) } })();
    </script>
</body>

</html>